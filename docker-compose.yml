services:
  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"   # HTTP (Redirects to HTTPS automatically)
      - "443:443" # HTTPS
    environment:
      - CADDY_EVIDENCE_USER=${CADDY_EVIDENCE_USER}
      - CADDY_EVIDENCE_PASSWORD_HASH=${CADDY_EVIDENCE_PASSWORD_HASH}
      - DOMAIN_NAME=${DOMAIN_NAME}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - ./local_files:/srv/files
    networks:
      - default
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  postgres:
    image: postgres:16-alpine
    container_name: postgres-visual-tester
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 1. n8n - The Logic Engine
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n-visual-tester
    user: "${UID}:${GID}"
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - HOME=/home/node
      - WEBHOOK_URL=${WEBHOOK_URL}
      - UPDATE_BASELINE_TOKEN=${UPDATE_BASELINE_TOKEN}
      - SLACK_WEBHOOK=${SLACK_WEBHOOK}
      - TARGET_WEBSITE_URL=${TARGET_WEBSITE_URL}
      - AI_API_KEY=${AI_API_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=false
      - N8N_TRUST_PROXY=true
      - N8N_PROXY_HOPS=1
      - N8N_SECURE_COOKIE=true
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
      - NODE_OPTIONS=--dns-result-order=ipv4first
      - GENERIC_TIMEZONE=${TIMEZONE}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_LOG_OUTPUT=console
      - NODE_FUNCTION_ALLOW_BUILTIN=fs
      - NODES_EXCLUDE=[]
      # Environment variables from .env
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_BLOCK_FILE_ACCESS_TO_N8N_FILES=false
      - N8N_RESTRICT_FILE_ACCESS_TO=/files
      - CADDY_EVIDENCE_USER=${CADDY_EVIDENCE_USER}
      - CADDY_EVIDENCE_PASSWORD=${CADDY_EVIDENCE_PASSWORD}
      
      # Database Settings
      - DB_TYPE=${DB_TYPE}
      - DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE}
      - DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST}
      - DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT}
      - DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_POSTGRESDB_PASSWORD}

      # 1. Pruning (Cleanup) Settings
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=48            # Keep data for 48 hours only

      # 2. Saving Settings
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all     # Save everything when it fails (for debugging)
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=none  # Save NOTHING when it passes
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=true # Optional: Helps debug long-running workflows
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "3"
    volumes:
      - ./n8n_data/config:/home/node/.n8n
      - ./n8n_data/cache:/home/node/.cache
      - ./local_files:/files
    # THIS IS THE BRIDGE TO YOUR MAC
    extra_hosts:
      - "host.docker.internal:host-gateway" 

  # 2. Browserless - The Headless Browser
  browserless:
    image: ghcr.io/browserless/chromium
    container_name: browserless-visual-tester
    ports:
      - "127.0.0.1:3000:3000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      # limit concurrency to save RAM
      - MAX_CONCURRENT_SESSIONS=10
      - TIMEOUT=60000
    shm_size: '2gb'
    restart: unless-stopped
    volumes:
      - ./fonts:/usr/share/fonts/truetype/custom

volumes:
  postgres_data:
  caddy_data:
  caddy_config:

networks:
  default:
    driver: bridge
